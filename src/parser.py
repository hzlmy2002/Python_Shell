from parsita import *
from appFactory import AppNotFoundError, appFactory
from commandTree import (
    Argument,
    InRedirection,
    OutRedirection,
    Call,
    Seq,
    Parameter,
    Pipe,
)
from apps.App import App


class CommandParsers(TextParsers, whitespace=None):
    singleQuoted = "'" >> reg(r"[^\n\r']*") << "'"
    backQuoted = "`" >> reg(r"[^\n\r`]*") << "`"
    doubleQuoted = (
        '"' >> rep("`" & reg(r"[^\n\r`]*") & "`" | reg(r"[^\n\r\"`]+")) << '"' > "".join
    )  # concatenate list returned by rep() into single quote string
    quoted = singleQuoted | backQuoted | doubleQuoted

    unquoted = reg(r"[^-\s'\"`;|<>][^\s'\"`;|<>]*")

    argument = (quoted | unquoted) > Argument
    parameter = reg(r"-[^\s'\"`;|<>]+") > Parameter

    whitespace = reg(r"[ \t]+")
    inRedirection = (">" >> whitespace >> argument) > InRedirection
    outRedirection = ("<" >> whitespace >> argument) > OutRedirection
    redirection = inRedirection | outRedirection

    atom = argument | redirection | parameter

    def getApp(arg: "Argument") -> Parser[str, "App"]:
        appName = arg.getArg()
        if appName not in appFactory().appMap:
            return failure(f"Application {appName} not found.")
        return success(appName)

    def makeCall(args) -> "Call":
        redirections = args[0]
        app = args[1]
        atoms = args[2]

        # merge sublists generated by combinator
        mergedArgs = redirections + atoms
        return Call(app, mergedArgs)

    call = (
        (opt(whitespace) >> rep(redirection << whitespace))
        & (argument >= getApp)
        & (rep(whitespace >> atom) << opt(whitespace))
    ) > makeCall

    seq = rep1sep(call, ";") > Seq
    pipe = rep1sep(call, "|") > Pipe

    command = longest(seq, pipe)


if __name__ == "__main__":
    command = CommandParsers.command.parse("echo eee | echo fff").or_die()
    call = command.getCalls()[0]
    print(call.getApp())
    for a in call.getArgs():
        print(a.getArg())
